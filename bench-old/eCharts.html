<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ECharts benchmark app</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="style.css" media="screen" />

    <link rel="stylesheet" href="uPlot.min.css" />
    <style>
      #wait,
      #reference {
        color: black;
      }
    </style>
  </head>
  <body>
    <h2 id="wait">Loading lib....</h2>

    <script src="config.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <div id="chart"></div>
    <script>
      let app = undefined

      const shiftingData = new Array(BENCHMARK_CONFIG.channelsCount)
        .fill(0)
        .map((_, iChannel) =>
          new Array(BENCHMARK_CONFIG.timeDomainInterval)
            .fill(0)
            .map((_, iDataPoint) => [
              iDataPoint,
              0,
            ])
        );

      const createChart = async () => {
        const container = document.getElementById('chart');
        const chart = echarts.init(container);
        const options = {
          animation: false,
          title: {},
          xAxis: {
            type: 'value',
          },
          yAxis: {
            type: 'value',
          },
          series: new Array(BENCHMARK_CONFIG.channelsCount)
            .fill(0)
            .map((_, iChannel) => ({
              name: `Channel #${iChannel}`,
              type: 'line',
              showSymbol: false,
              hoverAnimation: false,
              lineStyle: { width: BENCHMARK_CONFIG.strokeThickness },
              emphasis: {
                lineStyle: { width: BENCHMARK_CONFIG.strokeThickness },
              },
            })),
        };
        chart.setOption(options);

        app = {
          chart,
        }
      }

      const setData = async (data) => {
        iDataPoint = 0
        appendData(data)
      }

      let iDataPoint = 0
      const appendData = async (data) => {
        const n = data[0].length

        // Update visible data each frame to simulate data being streamed in.
        // (NOTE: means that user can't zoom to view older data along time domain).

        // Shift all channels data arrays by amount of new data points.
        shiftingData.forEach((values) => {
          for (let i = 0; i < n; i += 1) {
            values.shift(1);
          }
        });
        for (let iNewDataPoint = 0; iNewDataPoint < n; iNewDataPoint += 1) {
          // Add new value to each channel data array.
          for (
            let iChannel = 0;
            iChannel < BENCHMARK_CONFIG.channelsCount;
            iChannel += 1
          ) {
            const values = shiftingData[iChannel];
            const x = iDataPoint;
            const y = data[iChannel][iNewDataPoint];
            values.push([x, y]);
          }
          iDataPoint += 1;
        }

        app.chart.setOption({
          series: new Array(BENCHMARK_CONFIG.channelsCount)
            .fill(0)
            .map((_, iChannel) => ({
              data: shiftingData[iChannel],
            })),
          xAxis: {
            min: iDataPoint - BENCHMARK_CONFIG.timeDomainInterval,
            max: iDataPoint,
          },
        });
      }

      window.Test = {
        format: 'y-array',
        createChart,
        setData,
        appendData
      }

    </script>
    <script src="benchmark.js"></script>

    <p id="reference">
      Code based on
      <a
        href="https://echarts.apache.org/examples/en/editor.html?c=dynamic-data2"
        >https://echarts.apache.org/examples/en/editor.html?c=dynamic-data2</a
      >
    </p>
  </body>
</html>
